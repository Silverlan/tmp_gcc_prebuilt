name: Build GCC

on:
  workflow_dispatch:
    inputs:
      git_sha:
        description: 'Optional git SHA, branch, or tag to build (leave empty to build latest/default branch)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      issues: read
      pull-requests: read
    env:
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Checkout (workflow repo)
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            autoconf2.69 dwz lzma xz-utils libzstd-dev zlib1g-dev systemtap-sdt-dev \
            binutils gettext nvptx-tools amdgcn-tools-18 \
            texinfo sharutils procps netbase libisl-dev libmpc-dev libmpfr-dev libgmp-dev lib32z1-dev libx32z1-dev
          sudo apt-get clean

      - name: Fetch sources
        # clones the gcc source; if a git_sha input was provided, attempt to check it out
        run: |
          set -euo pipefail
          mkdir -p $HOME/gcc-16
          # Clone (full clone to allow tags/describes). If runner disk constraints are an issue,
          # switch to a shallow clone and fetch additional refs as needed.
          git clone https://github.com/gcc-mirror/gcc.git $HOME/gcc-16
          cd $HOME/gcc-16
          # Make sure tags are available for version detection
          git fetch --tags --prune || true

          if [ -n "${{ github.event.inputs.git_sha }}" ]; then
            echo "Using provided ref: ${{ github.event.inputs.git_sha }}"
            # Try fetch + checkout the provided ref (branch, tag or commit)
            git fetch --depth=1 origin "${{ github.event.inputs.git_sha }}" || true
            if git rev-parse --verify --quiet "${{ github.event.inputs.git_sha }}" >/dev/null; then
              git checkout --detach "${{ github.event.inputs.git_sha }}"
            else
              # as fallback, try to checkout FETCH_HEAD if fetch succeeded
              if [ -f .git/FETCH_HEAD ]; then
                git checkout --detach FETCH_HEAD || true
              fi
            fi
          else
            # No ref provided: stay on default branch (repo default), update to latest
            git checkout master 2>/dev/null || git checkout main 2>/dev/null || true
            git pull --ff-only 2>/dev/null || true
          fi

          # Prepare binutils alongside gcc (same as before)
          mkdir -p $HOME/binutils
          curl -L https://sourceware.org/pub/binutils/releases/binutils-2.45.tar.gz | tar -xz --strip-components=1 -C $HOME/binutils
          cd $HOME/gcc-16
          ln -s ../binutils/bfd ../binutils/gas ../binutils/binutils ../binutils/ld ../binutils/libctf \
             ../binutils/libsframe ../binutils/opcodes . || true

      - name: Configure
        run: |
          cd $HOME/gcc-16
          mkdir -p obj
          cd obj
          ../configure --enable-languages=c,c++,lto --prefix=/opt/gcc-16 --enable-checking=release --disable-bootstrap --disable-multilib

      - name: Build and install
        run: |
          cd $HOME/gcc-16/obj
          make BOOT_CFLAGS=-march=x86-64-v3 -j$(nproc || 3)
          sudo make -j$(nproc || 3) install-strip

      - name: Register alternatives
        run: |
          sudo update-alternatives --install /usr/bin/gcc-16 gcc-16 /opt/gcc-16/bin/gcc 160 --slave /usr/bin/g++-16 g++-16 /opt/gcc-16/bin/g++
          sudo update-alternatives --install /usr/bin/gcc gcc /opt/gcc-16/bin/gcc 160 --slave /usr/bin/g++ g++ /opt/gcc-16/bin/g++

      - name: Create tarball of /opt/gcc-16
        run: |
          sudo tar -C /opt -cJf /tmp/gcc-16-opt.tar.xz gcc-16
          ls -lh /tmp/gcc-16-opt.tar.xz

      # Determine GCC version (used in tag/release names)
      - name: Determine GCC version and build tag
        id: get_version
        shell: bash
        run: |
          set -euo pipefail
          cd $HOME/gcc-16

          # Ensure we have tags available
          git fetch --tags --prune || true

          # Try to resolve a human-friendly version:
          # 1) nearest annotated tag (if present)
          # 2) otherwise the most recent tag
          # 3) otherwise fallback to short commit
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            v="$(git describe --tags --abbrev=0)"
          else
            # try a broader describe
            v="$(git describe --tags --always --long 2>/dev/null || true)"
            if [ -z "$v" ]; then
              v="commit-$(git rev-parse --short HEAD)"
            fi
          fi

          # sanitize slashes (tags like releases/gcc-16.1.0) for safe use in tag names
          v="${v//\//-}"
          date="$(TZ='Europe/Berlin' date +%F)"

          # build_tag example: gcc-16.1.0-2026-01-26 or commit-abc123-2026-01-26
          build_tag="${v}-${date}"

          echo "gcc_version=$v" >> $GITHUB_OUTPUT
          echo "date=$date" >> $GITHUB_OUTPUT
          echo "build_tag=$build_tag" >> $GITHUB_OUTPUT

      - name: Generate nightly tag description
        shell: bash
        run: |
          printf "Pre-built binaries for GCC %s.\n\nBuilt on: %s\n" "${{ steps.get_version.outputs.gcc_version }}" "${{ steps.get_version.outputs.date }}" > tag_text.txt
          cat tag_text.txt

      # Checkout the repository where you want to create the tag (as original workflow did)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: "repo"

      - name: Create Tag
        uses: Silverlan/common_actions/create_tag@main
        with:
          tag_name: "${{ steps.get_version.outputs.build_tag }}"
          path: "repo"

      - name: Create/Update GitHub Release (tag+name include GCC version)
        uses: softprops/action-gh-release@v0.1.15
        with:
          body_path: tag_text.txt
          tag_name: "${{ steps.get_version.outputs.build_tag }}"
          target_commitish: ${{ github.sha }}
          prerelease: true
          # set release name to include the GCC version and date
          name: "Nightly build - GCC ${{ steps.get_version.outputs.gcc_version }} (${ { steps.get_version.outputs.date } })"

      - name: Update nightly release (upload artifact)
        uses: pyTooling/Actions/releaser/composite@v4.2.2
        with:
          tag: "${{ steps.get_version.outputs.build_tag }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          files: "/tmp/gcc-16-opt.tar.xz"
