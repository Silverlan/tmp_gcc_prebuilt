name: Build GCC

on:
  workflow_dispatch:
    inputs:
      git_sha:
        description: 'Optional git SHA, branch, or tag to build (leave empty to build latest/default branch)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      issues: read
      pull-requests: read
    env:
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Checkout (workflow repo)
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            autoconf2.69 dwz lzma xz-utils libzstd-dev zlib1g-dev systemtap-sdt-dev \
            binutils gettext nvptx-tools amdgcn-tools-18 \
            texinfo sharutils procps netbase libisl-dev libmpc-dev libmpfr-dev libgmp-dev lib32z1-dev libx32z1-dev
          sudo apt-get clean

      - name: Fetch sources
        # clones the gcc source; if a git_sha input was provided, attempt to check it out
        run: |
          set -euo pipefail
          mkdir -p $HOME/gcc
          # Clone (full clone to allow tags/describes). If runner disk constraints are an issue,
          # switch to a shallow clone and fetch additional refs as needed.
          git clone https://github.com/gcc-mirror/gcc.git $HOME/gcc
          cd $HOME/gcc
          # Make sure tags are available for version detection
          git fetch --tags --prune || true

          ref="${{ github.event.inputs.git_sha }}"
          if [ -n "${ref}" ]; then
            echo "Using provided ref: ${ref}"
            git fetch --depth=1 origin "${ref}" || { echo "git fetch failed"; exit 1; }
            git checkout --detach FETCH_HEAD || { echo "checkout FETCH_HEAD failed"; exit 1; }
          fi

          # Prepare binutils alongside gcc (same as before)
          mkdir -p $HOME/binutils
          curl -L https://sourceware.org/pub/binutils/releases/binutils-2.45.tar.gz | tar -xz --strip-components=1 -C $HOME/binutils
          cd $HOME/gcc
          ln -s ../binutils/bfd ../binutils/gas ../binutils/binutils ../binutils/ld ../binutils/libctf \
             ../binutils/libsframe ../binutils/opcodes . || true

      - name: Configure
        run: |
          cd $HOME/gcc
          mkdir -p obj
          cd obj
          ../configure --enable-languages=c,c++,lto --prefix=/opt/gcc --enable-checking=release --disable-bootstrap --disable-multilib

      - name: Build and install
        run: |
          cd $HOME/gcc/obj
          make BOOT_CFLAGS=-march=x86-64-v3 -j$(nproc || 3)
          sudo make -j$(nproc || 3) install-strip

      - name: Register alternatives
        run: |
          sudo update-alternatives --install /usr/bin/gcc gcc /opt/gcc/bin/gcc 160 --slave /usr/bin/g++ g++ /opt/gcc/bin/g++
          # If you still want a versioned sibling like gcc-16, add another install here (optional)

      # Determine GCC version and build tag (now that /opt/gcc exists)
      - name: Determine GCC version and build tag
        id: get_version
        shell: bash
        run: |
          set -euo pipefail
          cd $HOME/gcc

          # Ensure we have tags available
          git fetch --tags --prune || true

          # Try to resolve a human-friendly version:
          # 1) nearest annotated tag (if present)
          # 2) otherwise the most recent tag
          # 3) otherwise fallback to short commit
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            v="$(git describe --tags --abbrev=0)"
          else
            v="$(git describe --tags --always --long 2>/dev/null || true)"
            if [ -z "$v" ]; then
              v="commit-$(git rev-parse --short HEAD)"
            fi
          fi

          # Determine the git ref we built from (use input if provided; otherwise the short commit)
          git_ref="${{ github.event.inputs.git_sha }}"
          if [ -z "$git_ref" ]; then
            git_ref="$(git rev-parse --short HEAD)"
          fi

          # sanitize slashes (tags like releases/gcc-16.1.0) for safe use in names
          v="${v//\//-}"
          git_ref="${git_ref//\//-}"

          # get the actual installed gcc version (prefer -dumpfullversion, fallback to parsing --version)
          if /opt/gcc/bin/gcc -dumpfullversion >/dev/null 2>&1; then
            gcc_version="$(/opt/gcc/bin/gcc -dumpfullversion)"
          else
            gcc_version="$(/opt/gcc/bin/gcc --version | head -n1 | grep -oE '[0-9]+(\.[0-9]+){1,}' | head -n1 || true)"
            if [ -z "$gcc_version" ]; then
              gcc_version="unknown"
            fi
          fi

          # build_tag example: gcc-16.1.0-<ref>  (no date)
          build_tag="${v}-${git_ref}"

          # archive name: include the actual gcc version and the git ref
          archive_name="gcc-${gcc_version}-${git_ref}.tar.xz"

          echo "gcc_version=$gcc_version" >> $GITHUB_OUTPUT
          echo "git_ref=$git_ref" >> $GITHUB_OUTPUT
          echo "build_tag=$build_tag" >> $GITHUB_OUTPUT
          echo "archive_name=$archive_name" >> $GITHUB_OUTPUT

      - name: Generate nightly tag description
        shell: bash
        run: |
          printf "Pre-built binaries for GCC %s.\n\nBuilt from git ref: %s\n" "${{ steps.get_version.outputs.gcc_version }}" "${{ steps.get_version.outputs.git_ref }}" > tag_text.txt
          cat tag_text.txt

      - name: Create tarball of /opt/gcc
        run: |
          sudo tar -C /opt -cJf /tmp/${{ steps.get_version.outputs.archive_name }} gcc
          ls -lh /tmp/${{ steps.get_version.outputs.archive_name }}

      # Checkout the repository where you want to create the tag (as original workflow did)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: "repo"

      - name: Create Tag
        uses: Silverlan/common_actions/create_tag@main
        with:
          tag_name: "${{ steps.get_version.outputs.build_tag }}"
          path: "repo"

      - name: Create/Update GitHub Release (tag+name include GCC version and git ref)
        uses: softprops/action-gh-release@v0.1.15
        with:
          body_path: tag_text.txt
          tag_name: "${{ steps.get_version.outputs.build_tag }}"
          target_commitish: ${{ github.sha }}
          prerelease: true
          # set release name to include the GCC version and git ref (no date)
          name: "Nightly build - GCC ${{ steps.get_version.outputs.gcc_version }} (${{ steps.get_version.outputs.git_ref }})"

      - name: Update nightly release (upload artifact)
        uses: pyTooling/Actions/releaser/composite@v4.2.2
        with:
          tag: "${{ steps.get_version.outputs.build_tag }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          files: "/tmp/${{ steps.get_version.outputs.archive_name }}"
